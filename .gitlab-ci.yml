### GENERAL ###

variables:
  GITLAB_REMOTE:
    description: "The remote gitlab URL used."
    value: "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}:${CI_SERVER_PORT}/"
  LATEST_PYTHON:
    description: "The latest python version used to test this project."
    options:
      - "3.9"
      - "3.10"
      - "3.11"
      - "3.12"
    value: "3.12"

stages:
  - Checks
  - Tests Linux
  - Tests Windows

default:
  services:
    - run_as_root:false
  interruptible: true

# Common

.tox-common:
  before_script:
    - python -m pip install --force tox
  script:
    # Should be quoted using \' to deal with ':' in the command
    - 'echo "Tox run environment: ${CI_TOX_ENV:=py${PYTHON_VERSION:0:1}${PYTHON_VERSION:2:2}-cov-xdist}"'
    - python -m tox --colored yes -e ${CI_TOX_ENV}

### Linux jobs ###

.linux-image:
  services:
    - image:all-pythons
    - cpu:4
  before_script:
    - source /it/activate-py${PYTHON_VERSION:0:1}${PYTHON_VERSION:2:2}
    - python -m pip install -U pip

.linux-common:
  extends:
    - .linux-image
    - .tox-common
  before_script:
    - !reference [.linux-image, before_script]
    - !reference [.tox-common, before_script]

# Stage: Checks

Style:
  stage: Checks
  extends: .linux-common
  needs: []
  before_script:
    - !reference [.linux-common, before_script]
    - git config --global --add
      url."${GITLAB_REMOTE}/it/black.git".insteadOf
      https://github.com/ambv/black
    - git config --global --add
      url."${GITLAB_REMOTE}/it/flake8.git".insteadOf
      https://github.com/pycqa/flake8
    - python -m pip install pre-commit
    - pre-commit install
  script:
    - pre-commit run -a --show-diff-on-failure
    - !reference [.linux-common, script]
  variables:
    PYTHON_VERSION: ${LATEST_PYTHON}
    CI_TOX_ENV: mypy
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

Security:
  stage: Checks
  needs: []
  extends: .linux-common
  variables:
    PYTHON_VERSION: ${LATEST_PYTHON}
    CI_TOX_ENV: security
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

Documentations:
  stage: Checks
  needs: ["Style"]
  extends: .linux-common
  variables:
    PYTHON_VERSION: ${LATEST_PYTHON}
    CI_TOX_ENV: docs
  only:
    refs:
      - merge_requests
    changes:
      - docs/**/*
      - pyproject.toml
      - setup.cfg
      - tox.ini
      - .gitlab-ci.yml

# Stage: Tests

.test-linux:
  stage: Tests Linux
  extends: .linux-common
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.9", "3.10", "3.11", "3.12"]
  artifacts:
    when: always
    paths:
      - pytest-report.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
      junit: pytest-report.xml

Linux Python:
  extends: .test-linux
  needs: ["Style"]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# A job tiggered by 'Run Linux tests'. This jobs will run without waiting any others
# jobs.
Linux Python (always):
  extends: .test-linux
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline" && $CI_MERGE_REQUEST_ID && $CI_PROJECT_NAME == "e3-core" && $ALWAYS_LINUX_TESTS == "y"

# A manual jobs to run Linux tests even if "Style" jobs has been failed
Run Linux tests:
  stage: Tests Linux
  needs: []
  trigger:
    include: .gitlab-ci.yml
    strategy: depend
  variables:
    ALWAYS_LINUX_TESTS: "y"
    ALWAYS_WINDOWS_TESTS: "n"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
      allow_failure: true
  # Contrary to what the documentation might suggest, manual_confirmation
  # is not currently usable with our gitlab.
  # However, when it is, adding a manual confirmation to warn the user that
  # this job should only be used when previous steps have failed seems
  # useful. Something like:
  #
  # manual_confirmation: |-
  #     Are you sure you want to run Linux tests?
  #
  #     This is only useful if the previous stages have failed and you still want to run the tests.

### Windows jobs ###

.windows-image:
  services:
    - image:e3-windows-core-2022
    - platform:x86_64-windows-2022
    - cpu:2
    - mem:4
  before_script:
    - source /it/activate-python ${PYTHON_VERSION}
    - mkdir -p "C:/tmp/Trash"
    - python -m pip install -U pip

.windows-common:
  extends:
    - .windows-image
    - .tox-common
  before_script:
    - !reference [.windows-image, before_script]
    - !reference [.tox-common, before_script]

# Stage: Checks

#--- Nothing to do during this stage ---#

# Stage: Tests

.test-windows:
  stage: Tests Windows
  extends: .windows-common
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.9", "3.10", "3.11", "3.12"]

Windows Python:
  extends: .test-windows
  needs: ["Style"]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# A job tiggered by 'Run Windows tests'. This jobs will run without waiting any others
# jobs.
Windows Python (always):
  extends: .test-windows
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline" && $CI_MERGE_REQUEST_ID && $CI_PROJECT_NAME == "e3-core" && $ALWAYS_WINDOWS_TESTS == "y"

# A manual jobs to run Windows tests even if previous jobs has been failed
Run Windows tests:
  stage: Tests Windows
  needs: []
  trigger:
    include: .gitlab-ci.yml
    strategy: depend
  variables:
    ALWAYS_LINUX_TESTS: "n"
    ALWAYS_WINDOWS_TESTS: "y"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
      allow_failure: true
  # Contrary to what the documentation might suggest, manual_confirmation
  # is not currently usable with our gitlab.
  # However, when it is, adding a manual confirmation to warn the user that
  # this job should only be used when previous steps have failed seems
  # useful. Something like:
  #
  # manual_confirmation: |-
  #     Are you sure you want to run Windows tests?
  #
  #     This is only useful if the previous stages have failed and you still want to run the tests.
